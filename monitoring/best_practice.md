# 監視設定に必要なベストプラクティス

## 監視の本質は何か？
- アプリケーションが動いていることを担保できること
- それはつまりOSのメトリクスだけを見てもサービスを維持するという役割を果たしていることにはならない
- OSのメトリクスを取るなら高頻度短期間を心がける
- 監視の設定や定義は運用担当者だけの仕事ではない
- ただし、開発者には適切なヒアリングを行うことで協力関係を意識付けることが重要

## 監視のデザインパターン
- ログは構造化になっているほうが可視化しやすく取り回しもしやすい
- ただし、パースする必要がないログであれば非構造化でも問題はない
- 一定期間以上保管する必要の無いログは圧縮するなり、ストレージのライフサイクルに整理させよう
- 監視の開始地点はアプリケーションサーバ内部ではなく、ロードバランサーのエンドポイントから行うこと
- 監視結果から得られる数値は常に改善の指標とする

## アラート対応
- アラートの種類は「すぐに復旧を開始しなければならない」ものと「参考情報」に二分される
- 前者は継続的に自動復旧の仕組みを取り入れていこう
- アラートにメールを使っても誰も見なくなる
- アラートのログからレポートを作成できればSLAの実測にも役立つ
- アラートには手順書を内包し、経緯や注意点を書いておこう
- メンテナンス中のアラートに考慮しよう
- オンコール対応が必要ならローテーションを組むべき
- インシデントは自動で記録し、チケット化して改善策を考えること

## ビジネスの監視
- KPIを常に追えるようにしよう
- KPIを技術指標に結びつけよう
- 個別ユーザを追うのではなくサービスを利用する全体ユーザの行動を追うこと

## フロントエンドの監視
- アプリケーションの表示が遅いということは致命的
- Navigation Timing APIのメトリクスは参考になる
- Google Analyticsは活用すべき
- JavaScriptの例外やログメッセージは積極的に集約しよう
- WebpageTest.OrgもAPIを叩いて自動テストを回せるとより効率的になる

## バックエンドの監視
- APMは素晴らしいが頼り切ってもビジネスロジックを考慮しているわけではない
- ログインの失敗やログインに成功するまでの時間も計測しよう
- ビルドやデプロイの実行者とAPIの実行回数を照らし合わせるとトラブルシューティングに役立つこともある
- healthエンドポイントは重要、依存関係にあるデータストアとの接続確認も行うこと
- サービスが外部APIに依存しているならそれもヘルスチェックに加えるべき
- メトリクスにするかログにするかはチームで扱いやすい方を選択する

## OSメトリクスの監視
- メモリ監視はログに出力されるOOMKiller呼び出しを監視しよう
- ネットワーク監視はインターフェースのIn/Out、エラー、ドロップを監視しよう
- ディスク監視はIOPSの低下に注意すること
- ロードアベレージはあまり気にしなくてよい
- SSL証明書の有効期限は監視しておこう

## Webサーバの監視
- コネクション数よりリクエスト数に注目すべき

## DBサーバの監視
- コネクション数の監視は必須
- 病患クエリ数やスロークエリ、IOPSも重要な指標

## ロードバランサーの監視
- healthエンドポイントに注目しよう

## メッセージキュー
- キューの長さとキューから取り出され処理されたメッセージの消費率を監視しよう

## キャッシュ
- evicted itemsとhit/miss、cache-hitが重要

## スケジュールジョブ
- 動いていることの担保をしつつ、動かなかった場合に検知できるようにしたい

## ログの分析
- 統計分析のできるツール、SplunkやELKスタックなどのツールを使いこなそう

## セキュリティ
- auditログの収集やrootkitの導入も視野に入れよう
- ネットワークの侵入検知もSIEMへ送れるようにしたい

## 具体的な監視メトリクス例
- ページロード時間
- ユーザログインの成功、失敗、実行時間、DAU、WAU、MAU
- 検索実行数およびレイテンシ
- レビュー・コメント投稿数およびレイテンシ
- クエリレイテンシ
- 病患トランザクション数、キャッシュヒット・キャッシュミス
- CDNからオリジンへのレイテンシ
- HAProxy
- 病患リクエスト数、HTTPレスポンスコード
- OSメトリクス

## 具体的な監視ログ例
- ユーザログイン時のID、コンテキスト
- フレームワークの例外、トレースバック
- デーモンのサービスログ

## 具体的なセキュリティ監視例
- SSH試行
- syslog
- auditlog

## 具体的なアラート設定例
- ページロード時間
- デーモンや依存関係にあるサービスのエラー率、レイテンシ
- ユーザアクションに伴うエラー率、レイテンシ
- クエリレイテンシ